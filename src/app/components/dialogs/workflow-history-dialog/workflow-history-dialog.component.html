<div class="dialog-overlay" *ngIf="isVisible" (click)="close()">
  <div class="dialog-container" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2>üìã Workflow History</h2>
      <h3>{{ workflowName || 'Workflow' }}</h3>
      <button class="btn-close" (click)="close()">√ó</button>
    </div>

    <div class="dialog-tabs">
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'history'"
        (click)="activeTab = 'history'">
        üìú History
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'stats'"
        (click)="activeTab = 'stats'">
        üìä Statistics
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'comparison'"
        [disabled]="!showComparison"
        (click)="activeTab = 'comparison'">
        üîÑ Comparison
      </button>
    </div>

    <div class="dialog-content">
      <!-- Loading -->
      <div *ngIf="loading" class="loading-state">
        <div class="spinner"></div>
        <p>Loading history...</p>
      </div>

      <!-- History Tab -->
      <div *ngIf="activeTab === 'history' && !loading" class="history-tab">
        <div class="history-filters">
          <div class="filter-group">
            <label for="filterType">Filter by type:</label>
            <select id="filterType" [(ngModel)]="filterType" (change)="onFilterChange()">
              <option value="all">All</option>
              <option value="created">Created</option>
              <option value="modified">Modified</option>
              <option value="executed">Executed</option>
              <option value="restored">Restored</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="filterLimit">Limit:</label>
            <select id="filterLimit" [(ngModel)]="filterLimit" (change)="onFilterChange()">
              <option value="20">20</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
          </div>

          <div class="filter-actions">
            <button 
              class="btn btn-sm btn-primary" 
              [disabled]="selectedEntries.length !== 2"
              (click)="compareVersions()">
              üîÑ Compare Selected
            </button>
          </div>
        </div>

        <div class="history-entries" *ngIf="filteredEntries.length > 0">
          <div 
            class="history-entry"
            *ngFor="let entry of filteredEntries; trackBy: trackByEntryId"
            [class.selected]="isSelected(entry)"
            (click)="selectEntry(entry)">
            
            <div class="entry-header">
              <div class="entry-version">
                <span class="version-badge">v{{ entry.version }}</span>
                <span class="entry-type">
                  {{ getChangeTypeIcon(entry.changeType) }}
                  {{ getChangeTypeLabel(entry.changeType) }}
                </span>
              </div>
              
              <div class="entry-timestamp">
                {{ formatTimestamp(entry.timestamp) }}
              </div>
            </div>

            <div class="entry-description">
              {{ entry.changeDescription }}
            </div>

            <div class="entry-details" *ngIf="entry.executionData">
              <div class="execution-info">
                <span class="execution-status">
                  {{ getExecutionStatusIcon(entry.executionData.status) }}
                  {{ entry.executionData.status === 'completed' ? 'Success' : 'Failed' }}
                </span>
                <span class="execution-duration" *ngIf="entry.executionData.duration">
                  ‚è±Ô∏è {{ formatDuration(entry.executionData.duration) }}
                </span>
                <span class="execution-nodes">
                  üì¶ {{ entry.executionData.nodeCount }} nodes
                </span>
                <span class="execution-errors" *ngIf="entry.executionData.errorCount > 0">
                  ‚ùå {{ entry.executionData.errorCount }} errors
                </span>
              </div>
            </div>

            <div class="entry-actions">
              <button 
                class="btn btn-xs btn-outline"
                (click)="$event.stopPropagation(); restoreVersion(entry.version)">
                üîÑ Restore
              </button>
            </div>
          </div>
        </div>

        <div class="no-history" *ngIf="filteredEntries.length === 0 && !loading">
          <p>üìù No history found for this workflow.</p>
        </div>
      </div>

      <!-- Statistics Tab -->
      <div *ngIf="activeTab === 'stats' && !loading" class="stats-tab">
        <div class="stats-grid" *ngIf="historyStats">
          <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-info">
              <h4>Total Versions</h4>
              <p class="stat-value">{{ historyStats.totalVersions }}</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">‚ñ∂Ô∏è</div>
            <div class="stat-info">
              <h4>Executions</h4>
              <p class="stat-value">{{ historyStats.totalExecutions }}</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">üìù</div>
            <div class="stat-info">
              <h4>Modifications</h4>
              <p class="stat-value">{{ historyStats.totalModifications }}</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-info">
              <h4>Success Rate</h4>
              <p class="stat-value">{{ historyStats.successRate | number:'1.1-1' }}%</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-info">
              <h4>Average Time</h4>
              <p class="stat-value">{{ formatDuration(historyStats.averageExecutionTime) }}</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">üïí</div>
            <div class="stat-info">
              <h4>Last Execution</h4>
              <p class="stat-value">
                {{ historyStats.lastExecution ? formatTimestamp(historyStats.lastExecution) : 'Never' }}
              </p>
            </div>
          </div>
        </div>

        <div class="no-stats" *ngIf="!historyStats">
          <p>üìä No statistics available for this workflow.</p>
        </div>
      </div>

      <!-- Comparison Tab -->
      <div *ngIf="activeTab === 'comparison' && comparisonResult" class="comparison-tab">
        <div class="comparison-header">
          <h3>Version Comparison</h3>
          <button class="btn btn-sm btn-outline" (click)="closeComparison()">
            ‚úï Close Comparison
          </button>
        </div>

        <div class="comparison-versions">
          <div class="version-info">
            <h4>Version {{ comparisonResult.oldVersion.version }}</h4>
            <p>{{ formatTimestamp(comparisonResult.oldVersion.timestamp) }}</p>
            <p>{{ comparisonResult.oldVersion.changeDescription }}</p>
          </div>
          
          <div class="comparison-arrow">‚Üí</div>
          
          <div class="version-info">
            <h4>Version {{ comparisonResult.newVersion.version }}</h4>
            <p>{{ formatTimestamp(comparisonResult.newVersion.timestamp) }}</p>
            <p>{{ comparisonResult.newVersion.changeDescription }}</p>
          </div>
        </div>

        <div class="comparison-differences">
          <h4>Differences</h4>
          <div class="diff-grid">
            <div class="diff-item">
              <span class="diff-label">Nodes Added:</span>
              <span class="diff-value">{{ comparisonResult.differences.nodesAdded }}</span>
            </div>
            <div class="diff-item">
              <span class="diff-label">Nodes Removed:</span>
              <span class="diff-value">{{ comparisonResult.differences.nodesRemoved }}</span>
            </div>
            <div class="diff-item">
              <span class="diff-label">Nodes Modified:</span>
              <span class="diff-value">{{ comparisonResult.differences.nodesModified }}</span>
            </div>
            <div class="diff-item">
              <span class="diff-label">Connections Added:</span>
              <span class="diff-value">{{ comparisonResult.differences.connectionsAdded }}</span>
            </div>
            <div class="diff-item">
              <span class="diff-label">Connections Removed:</span>
              <span class="diff-value">{{ comparisonResult.differences.connectionsRemoved }}</span>
            </div>
            <div class="diff-item">
              <span class="diff-label">Metadata Changed:</span>
              <span class="diff-value">{{ comparisonResult.differences.metadataChanged ? 'Yes' : 'No' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="dialog-footer">
      <div class="footer-info">
        <span *ngIf="workflowHistory">
          {{ workflowHistory.totalEntries }} history entries
        </span>
      </div>
      <div class="footer-actions">
        <button class="btn btn-outline" (click)="close()">
          Close
        </button>
      </div>
    </div>
  </div>
</div> 