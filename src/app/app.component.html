<div class="circuit-craft-app">
      <!-- Modern Header with Glassmorphism -->
      <header class="app-header">
        <div class="header-left">
          <div class="logo-section">
            <div class="logo-icon">‚ö°</div>
            <div class="logo-text">
              <h1>Circuit Craft</h1>
              <span class="tagline">Visual Automation Builder</span>
            </div>
          </div>
          
          <div class="workflow-title-section">
            <input
              type="text"
              [(ngModel)]="workflowName"
              placeholder="Untitled Workflow"
              class="workflow-title-input"
            >
            <div class="workflow-meta">
              <span class="node-count">{{ nodeCount }} nodes</span>
              <span class="connection-count">{{ connectionCount }} connections</span>
            </div>
          </div>
        </div>

        <div class="header-center">
          <div class="execution-controls">
            <button class="btn btn-execute" (click)="executeWorkflow()">
              <span>‚ñ∂Ô∏è</span>
              Executar
            </button>
            <button class="btn btn-secondary" (click)="clearWorkflow()">
              <span>üóëÔ∏è</span>
              Limpar
            </button>
            <button class="btn btn-outline" (click)="saveWorkflow()">
              <span>üíæ</span>
              Salvar
            </button>
            <button class="btn btn-outline" (click)="openLoadDialog()">
              <span>üìÇ</span>
              Carregar
            </button>
          </div>
        </div>

        <div class="header-right">
          <div class="canvas-controls">
            <button class="btn btn-icon" (click)="zoomOut()" title="Zoom Out">
              <i class="icon">üîç-</i>
            </button>
            <span class="zoom-display">{{ currentZoom }}%</span>
            <button class="btn btn-icon" (click)="zoomIn()" title="Zoom In">
              <i class="icon">üîç+</i>
            </button>
            <button class="btn btn-icon" (click)="resetZoom()" title="Fit to Screen">
              <i class="icon">‚ö°</i>
            </button>
          </div>
          
          <div class="status-indicator" [class]="workflowStatus.toLowerCase().replace(' ', '-')">
            <div class="status-dot"></div>
            <span>{{ workflowStatus }}</span>
          </div>
        </div>
      </header>

      <!-- Main Workspace -->
      <div class="app-workspace">
        <!-- Enhanced Sidebar -->
        <aside class="sidebar" [class.collapsed]="false">
          <div class="sidebar-header">
            <h3>Components</h3>
            <div class="search-container">
              <input
                type="text"
                placeholder="Search components..."
                class="search-input"
                [(ngModel)]="searchTerm"
                (input)="filterConnectors()"
              >
              <i class="search-icon">üîç</i>
            </div>
          </div>

          <div class="components-grid">
            <div *ngFor="let category of categories" class="component-category">
              <div class="category-header" (click)="toggleCategory(category.name)">
                <span class="category-icon">{{ category.expanded ? 'üìÇ' : 'üìÅ' }}</span>
                <span class="category-name">{{ category.name }}</span>
                <span class="category-count">({{ getFilteredConnectors(category.name).length }})</span>
              </div>

              <div *ngIf="category.expanded" class="category-components">
                <div
                  *ngFor="let connector of getFilteredConnectors(category.name)"
                  class="component-card"
                  draggable="true"
                  (dragstart)="onDragStart($event, connector)"
                >
                  <div class="component-icon">{{ connector.icon }}</div>
                  <div class="component-info">
                    <div class="component-name">{{ connector.name }}</div>
                    <div class="component-description">{{ connector.description }}</div>
                  </div>
                  <div class="component-meta">
                    <span class="input-count" *ngIf="connector.inputs > 0">{{ connector.inputs }}üì•</span>
                    <span class="output-count" *ngIf="connector.outputs > 0">{{ connector.outputs }}üì§</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </aside>

        <!-- Enhanced Canvas -->
        <main class="canvas-container">
          <!-- Canvas Toolbar -->
          <div class="canvas-toolbar">
            <div class="toolbar-left">
              <div class="node-selection-info" *ngIf="selectedNode">
                <div class="selected-node-badge">
                  <span class="node-icon">{{ getNodeIcon(selectedNode.type) }}</span>
                  <span class="node-name">{{ selectedNode.name }}</span>
                  <button class="btn btn-xs btn-ghost" (click)="openConfigDialog()">
                    <i class="icon">‚öôÔ∏è</i>
                  </button>
                </div>
              </div>
            </div>
            
            <div class="toolbar-right">
              <div class="canvas-info">
                <span class="canvas-hint">üí° Double-click nodes to configure</span>
              </div>
            </div>
          </div>

          <!-- Main Canvas -->
          <div class="canvas-wrapper">
            <div
              #drawflowContainer
              id="drawflow"
              class="canvas"
              (drop)="onDrop($event)"
              (dragover)="onDragOver($event)"
            ></div>
            
            <!-- Canvas Overlay for Empty State -->
            <div class="canvas-empty-state" *ngIf="nodeCount === 0">
              <div class="empty-state-content">
                <div class="empty-state-icon">üöÄ</div>
                <h3>Start Building Your Workflow</h3>
                <p>Drag components from the sidebar to create your automation</p>
                <div class="quick-start-buttons">
                  <button class="btn btn-outline" (click)="addQuickStartNode('http-request')">
                    <i class="icon">üåê</i>
                    Add HTTP Request
                  </button>
                  <button class="btn btn-outline" (click)="addQuickStartNode('transform')">
                    <i class="icon">üîÑ</i>
                    Add Transform
                  </button>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>

      <!-- Modern Modal Dialog -->
      <div class="dialog-overlay" *ngIf="showConfigDialog" (click)="closeConfigDialog()">
        <div class="dialog-container" (click)="$event.stopPropagation()">
          <!-- Dialog Header -->
          <div class="dialog-header">
            <div class="dialog-header-content">
              <div class="node-type-indicator" [attr.data-type]="selectedNode?.type">
                <span class="node-icon">{{ getNodeIcon(selectedNode?.type) }}</span>
              </div>
              <div class="dialog-title-section">
                <h2>{{ getNodeDisplayName(selectedNode?.type) }}</h2>
                <p>Configure your node settings</p>
              </div>
            </div>
            <button class="dialog-close-btn" (click)="closeConfigDialog()">
              <i class="icon">‚úï</i>
            </button>
          </div>

          <!-- Dialog Content -->
          <div class="dialog-body" *ngIf="selectedNode">
            <!-- Node Basic Info -->
            <div class="config-section">
              <div class="section-header">
                <h3>Basic Information</h3>
              </div>
              <div class="form-group">
                <label>Node Name</label>
                <input
                  type="text"
                  [(ngModel)]="selectedNode.name"
                  (ngModelChange)="onConfigChange()"
                  class="form-input"
                  placeholder="Enter node name..."
                >
              </div>
            </div>

            <!-- Display Data Section -->
            <div class="config-section" *ngIf="selectedNode?.type === 'display-data'">
              <div class="section-header">
                <h3>üìä Visualiza√ß√£o de Dados</h3>
                <span class="section-badge">Output</span>
              </div>

              <div class="form-group">
                <label for="format">Formato de Exibi√ß√£o</label>
                <select 
                  id="format" 
                  class="form-select" 
                  [(ngModel)]="selectedNode.config.format"
                  (change)="onConfigChange()">
                  <option value="table">Tabela</option>
                  <option value="json">JSON</option>
                  <option value="raw">Raw</option>
                </select>
              </div>

              <!-- Data Preview -->
              <div class="transform-panel">
                <div class="panel-header">
                  <h4>üíæ Dados de Entrada</h4>
                  <button class="btn btn-xs btn-ghost" 
                          (click)="executeWorkflow()"
                          title="Atualizar dados">
                    üîÑ
                  </button>
                </div>
                <div class="data-viewer">
                  <div *ngIf="getInputPreview(selectedNode.id); else noInputData">
                    <pre>{{ getInputPreview(selectedNode.id) | json }}</pre>
                  </div>
                  <ng-template #noInputData>
                    <div class="no-data-message">
                      <div class="icon">üì≠</div>
                      <p>Nenhum dado dispon√≠vel</p>
                      <small>Execute o workflow para ver os dados</small>
                    </div>
                  </ng-template>
                </div>
              </div>

              <!-- Results Display -->
              <div class="transform-panel" *ngIf="displayDataResults[selectedNode.id]">
                <div class="panel-header">
                  <h4>üìä Dados Visualizados</h4>
                  <span class="section-badge success">Executado</span>
                </div>
                <div class="data-viewer" *ngIf="displayDataResults[selectedNode.id].format === 'table'">
                  <!-- Table View -->
                  <div class="table-container" *ngIf="getTableColumns(displayDataResults[selectedNode.id].data).length > 0">
                    <table class="data-table">
                      <thead>
                        <tr>
                          <th *ngFor="let column of getTableColumns(displayDataResults[selectedNode.id].data)">
                            {{ column }}
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let row of getTableRows(displayDataResults[selectedNode.id].data)">
                          <td *ngFor="let column of getTableColumns(displayDataResults[selectedNode.id].data)">
                            {{ row[column] }}
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div *ngIf="getTableColumns(displayDataResults[selectedNode.id].data).length === 0" class="no-data-message">
                    <div class="icon">üìä</div>
                    <p>Nenhum dado para exibir em tabela</p>
                  </div>
                </div>
                <div class="data-viewer" *ngIf="displayDataResults[selectedNode.id].format !== 'table'">
                  <pre>{{ displayDataResults[selectedNode.id].data | json }}</pre>
                </div>
              </div>
            </div>

            <!-- Node-specific Configuration -->
            <div class="config-section" *ngIf="selectedNode.type === 'http-request'">
              <div class="section-header">
                <h3>HTTP Request Configuration</h3>
                <span class="section-badge">Required</span>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label>URL</label>
                  <input
                    type="url"
                    [(ngModel)]="selectedNode.config.url"
                    (ngModelChange)="onConfigChange()"
                    placeholder="https://api.example.com/endpoint"
                    class="form-input"
                  >
                </div>
                <div class="form-group form-group-sm">
                  <label>Method</label>
                  <select
                    [(ngModel)]="selectedNode.config.method"
                    (ngModelChange)="onConfigChange()"
                    class="form-select"
                  >
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label>Headers</label>
                <textarea
                  [(ngModel)]="selectedNode.config.headers"
                  (ngModelChange)="onConfigChange()"
                  placeholder='{"Content-Type": "application/json"}'
                  class="form-textarea code-editor"
                  rows="3"
                ></textarea>
              </div>

              <div class="form-group" *ngIf="selectedNode.config.method === 'POST' || selectedNode.config.method === 'PUT'">
                <label>Request Body</label>
                <textarea
                  [(ngModel)]="selectedNode.config.body"
                  (ngModelChange)="onConfigChange()"
                  placeholder='{"key": "value"}'
                  class="form-textarea code-editor"
                  rows="4"
                ></textarea>
              </div>
            </div>

            <!-- Transform Configuration (Enhanced) -->
            <div class="config-section" *ngIf="selectedNode.type === 'transform'">
              <div class="section-header">
                <h3>Data Transformation</h3>
                <span class="section-badge advanced">Advanced</span>
              </div>

              <!-- Input Preview -->
              <div class="transform-panel">
                <div class="panel-header">
                  <h4>üì• Input Data</h4>
                  <button class="btn btn-xs btn-outline" (click)="previewData[selectedNode.id] = generateSampleData()">
                    Generate Sample
                  </button>
                </div>
                <div class="data-viewer">
                  <pre *ngIf="getInputPreview(selectedNode.id) || previewData[selectedNode.id]; else noData">{{ getInputPreview(selectedNode.id) || previewData[selectedNode.id] | json }}</pre>
                  <ng-template #noData>
                    <div class="no-data-message">
                      <i class="icon">üì≠</i>
                      <span>Connect an input node to see data</span>
                    </div>
                  </ng-template>
                </div>
              </div>

              <!-- Field Mappings -->
              <div class="transform-panel">
                <div class="panel-header">
                  <h4>üîß Field Mappings</h4>
                  <button class="btn btn-xs btn-primary" (click)="addTransformMapping(selectedNode.id)">
                    Add Mapping
                  </button>
                </div>
                
                <div class="mappings-list">
                  <div 
                    *ngFor="let mapping of transformMappings[selectedNode.id]; let i = index" 
                    class="mapping-card"
                    [class.disabled]="!mapping.enabled">
                    
                    <div class="mapping-header">
                      <input type="checkbox" [(ngModel)]="mapping.enabled" (change)="updateTransformConfig(selectedNode.id)" class="mapping-toggle">
                      <select [(ngModel)]="mapping.type" (ngModelChange)="updateTransformConfig(selectedNode.id)" class="mapping-type-select">
                        <option value="direct">üìã Direct Copy</option>
                        <option value="constant">üìå Constant Value</option>
                        <option value="computed">‚öôÔ∏è Computed</option>
                      </select>
                      <button class="btn btn-xs btn-ghost mapping-delete" (click)="removeTransformMapping(selectedNode.id, i)">
                        üóëÔ∏è
                      </button>
                    </div>

                    <div class="mapping-content">
                      <div class="form-row" *ngIf="mapping.type === 'direct'">
                        <div class="form-group">
                          <label>Source Field</label>
                          <select [(ngModel)]="mapping.sourceField" (ngModelChange)="updateTransformConfig(selectedNode.id)" class="form-select">
                            <option value="">Select field...</option>
                            <option *ngFor="let field of extractAvailableFields(getInputPreview(selectedNode.id) || previewData[selectedNode.id])" [value]="field">
                              {{ field }}
                            </option>
                          </select>
                        </div>
                        <div class="form-group">
                          <label>Target Field</label>
                          <input type="text" [(ngModel)]="mapping.targetField" (ngModelChange)="updateTransformConfig(selectedNode.id)" placeholder="targetFieldName" class="form-input">
                        </div>
                      </div>

                      <div class="form-group" *ngIf="mapping.type !== 'direct'">
                        <label>Target Field</label>
                        <input type="text" [(ngModel)]="mapping.targetField" (ngModelChange)="updateTransformConfig(selectedNode.id)" placeholder="targetFieldName" class="form-input">
                      </div>

                      <div class="form-group" *ngIf="mapping.type === 'constant'">
                        <label>Constant Value</label>
                        <input type="text" [(ngModel)]="mapping.value" (ngModelChange)="updateTransformConfig(selectedNode.id)" placeholder="Fixed value" class="form-input">
                      </div>

                      <div class="form-group" *ngIf="mapping.type === 'computed'">
                        <label>Expression</label>
                        <textarea [(ngModel)]="mapping.value" (ngModelChange)="updateTransformConfig(selectedNode.id)" placeholder="data.field1 + ' - ' + data.field2" class="form-textarea code-editor" rows="2"></textarea>
                      </div>

                      <div class="mapping-preview" *ngIf="mapping.enabled && mapping.targetField">
                        <label>Preview:</label>
                        <code>{{ getNestedValue(getInputPreview(selectedNode.id) || previewData[selectedNode.id], mapping.sourceField) | json }}</code>
                      </div>
                    </div>
                  </div>

                  <div *ngIf="!transformMappings[selectedNode.id] || transformMappings[selectedNode.id].length === 0" class="empty-mappings">
                    <i class="icon">üìù</i>
                    <span>No mappings configured. Add your first mapping above.</span>
                  </div>
                </div>
              </div>

              <!-- Output Preview -->
              <div class="transform-panel">
                <div class="panel-header">
                  <h4>üì§ Output Preview</h4>
                </div>
                <div class="data-viewer">
                  <pre *ngIf="generateTransformPreview(selectedNode.id); else noOutput">{{ generateTransformPreview(selectedNode.id) | json }}</pre>
                  <ng-template #noOutput>
                    <div class="no-data-message">
                      <i class="icon">‚öôÔ∏è</i>
                      <span>Configure mappings to see output</span>
                    </div>
                  </ng-template>
                </div>
              </div>
            </div>

            <!-- Filter Section -->
            <div class="config-section" *ngIf="selectedNode?.type === 'filter'">
              <!-- ... existing code ... -->
            </div>

            <!-- Execution Results -->
            <div class="config-section" *ngIf="executionResults[selectedNode.id]">
              <div class="section-header">
                <h3>Execution Results</h3>
                <span class="section-badge success">Success</span>
              </div>
              <div class="execution-result-viewer">
                <pre>{{ executionResults[selectedNode.id] | json }}</pre>
              </div>
            </div>
          </div>

          <!-- Dialog Footer -->
          <div class="dialog-footer">
            <div class="footer-left">
              <button class="btn btn-danger" (click)="deleteSelectedNode()">
                <i class="icon">üóëÔ∏è</i>
                Delete Node
              </button>
            </div>
            <div class="footer-right">
              <button class="btn btn-secondary" (click)="closeConfigDialog()">Cancel</button>
              <button class="btn btn-primary" (click)="closeConfigDialog()">Save Changes</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Load Workflow Dialog -->
    <div class="dialog-overlay" *ngIf="showLoadDialog" (click)="closeLoadDialog()">
      <div class="dialog-container" style="max-width: 600px" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <div class="dialog-header-content">
            <div class="node-type-indicator" style="background: #dcfce7; border-color: #86efac;">
              <span class="node-icon">üìÇ</span>
            </div>
            <div class="dialog-title-section">
              <h2>Carregar Workflow</h2>
              <p>Selecione um workflow salvo para carregar</p>
            </div>
          </div>
          <button class="dialog-close-btn" (click)="closeLoadDialog()">
            ‚úï
          </button>
        </div>

        <div class="dialog-body">
          <div *ngIf="savedWorkflows.length === 0" class="no-data-message">
            <div class="icon">üì≠</div>
            <h3>Nenhum workflow salvo</h3>
            <p>Crie e salve um workflow primeiro para poder carreg√°-lo aqui.</p>
          </div>

          <div *ngIf="savedWorkflows.length > 0" class="workflows-list">
            <div class="workflow-card" 
                 *ngFor="let workflow of savedWorkflows"
                 (click)="loadWorkflow(workflow)">
              <div class="workflow-info">
                <div class="workflow-header">
                  <h3>{{ workflow.name || 'Workflow sem nome' }}</h3>
                  <div class="workflow-actions">
                    <button class="btn btn-xs btn-danger" 
                            (click)="$event.stopPropagation(); deleteWorkflow(workflow.id)"
                            title="Deletar workflow">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
                <div class="workflow-meta">
                  <span class="created-date">
                    üìÖ {{ workflow.createdAt | date:'dd/MM/yyyy HH:mm' }}
                  </span>
                  <span class="node-count" *ngIf="workflow.data?.drawflow?.Home?.data">
                    üì¶ {{ (workflow.data.drawflow.Home.data | keyvalue).length }} nodes
                  </span>
                </div>
              </div>
              <div class="workflow-preview">
                <span class="preview-icon">üöÄ</span>
              </div>
            </div>
          </div>
        </div>

        <div class="dialog-footer">
          <div class="footer-left">
            <span class="status-text">{{ savedWorkflows.length }} workflow(s) dispon√≠vel(is)</span>
          </div>
          <div class="footer-right">
            <button class="btn btn-outline" (click)="closeLoadDialog()">
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>
